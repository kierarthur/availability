<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111111" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Arthur Rai" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="APPICON-192.png" />
  <link rel="icon" type="image/png" href="APPICON-192.png" />
  <title>Availability</title>

  <style>
    :root {
      --bg: #0f1115;
      --panel: #161a22;
      --muted: #a7b0c0;
      --text: #e7ecf3;
      --accent: #4f8cff;
      --danger: #e06666;
      --ok: #6aa84f;
      --warn: #c8a94a;
      --tile: #1b212c;
      --tile-hover: #222a38;
      --booked: #4a86e8;
      --blocked: #6aa84f;

      /* Reserved dynamically by JS so content never sits under the fixed footer */
      --footer-h: 76px;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      height: 100%;
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-text-size-adjust: 100%;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      gap: .6rem;
      flex-wrap: wrap;
      padding: .6rem .9rem;
      background: rgba(15, 17, 21, .9);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid #222936;
      overflow: visible;
    }

    .name-and-logo {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: .2rem;
      z-index: 2;
    }

    #candidateName {
      margin: 0;
      font-size: 1.35rem;
      line-height: 1.1;
      font-weight: 800;
      letter-spacing: .2px;
      position: relative;
      z-index: 2;
    }

    .last-loaded {
      font-size: .85rem;
      color: var(--muted);
      margin-top: .1rem;
    }

    .company-logo-overlay {
      position: absolute;
      left: 0;
      top: calc(100% + 4px);
      z-index: 1;
      pointer-events: none;
      opacity: .25;
      width: auto;
      height: auto;
      max-width: min(65vw, 520px);
      max-height: 280px;
    }

    @media (max-width: 900px) {
      .company-logo-overlay {
        max-width: min(70vw, 420px);
        max-height: 220px;
        opacity: .22;
      }
    }

    @media (max-width: 560px) {
      .company-logo-overlay {
        max-width: 60vw;
        max-height: 180px;
        opacity: .20;
      }
    }

    header .spacer { flex: 1; }

    button, .btn {
      appearance: none;
      border: 0;
      outline: 0;
      cursor: pointer;
      border-radius: 10px;
      padding: .5rem .7rem;
      font-weight: 600;
      font-size: .9rem;
      background: var(--panel);
      color: var(--text);
      transition: background .15s ease, opacity .15s ease;
      position: relative;
      z-index: 2;
    }

    button:hover { background: #1e2532; }
    button:disabled { opacity: .55; cursor: not-allowed; }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-ghost { background: transparent; color: var(--muted); }

    main {
      max-width: 1024px;
      width: 100%;
      margin: 0 auto;
      padding: .6rem .9rem 0;
      box-sizing: border-box;
      /* Reserve real footer height so content never sits underneath */
      padding-bottom: calc(var(--footer-h) + env(safe-area-inset-bottom));
      scroll-padding-bottom: calc(var(--footer-h) + env(safe-area-inset-bottom) + 12px);
    }

    #helpMsg {
      display: block;
      margin: .15rem 0 .6rem;
      padding: .45rem .6rem;
      border-radius: 10px;
      font-size: .9rem;
      color: var(--muted);
      border: 1px solid #2a3446;
      background: #131926;
      position: relative;
      z-index: 1;
    }

    /* Grid */
    .grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: .6rem;
      width: 100%;
      max-width: 100%;
    }

    @media (max-width: 900px) { .grid { grid-template-columns: repeat(5, 1fr); } }
    @media (max-width: 700px) { .grid { grid-template-columns: repeat(4, 1fr); } }
    @media (max-width: 560px) { .grid { grid-template-columns: repeat(3, 1fr); } }

    /* Tiles */
    .tile {
      background: var(--tile);
      border: 1px solid #222a36;
      border-radius: 14px;
      padding: .6rem;
      display: grid;
      grid-template-rows: auto auto auto;
      transition: background .15s ease;
    }

    .tile:hover { background: var(--tile-hover); }

    .tile-header {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: .1rem;
    }

    .tile-day {
      font-weight: 800;
      letter-spacing: .5px;
      font-size: .95rem;
      color: var(--muted);
      text-transform: uppercase;
      line-height: 1.2;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    .tile-date {
      font-size: .95rem;
      color: var(--text);
      font-weight: 700;
      margin-left: .05rem;
      line-height: 1.2;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    .tile-status {
      margin-top: .3rem;
      font-size: 1rem;
      font-weight: 800;
      line-height: 1.25;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    /* New theme classes applied by JS */
    .tile.tile--bg-booked    { background: #3282F6; }  /* vivid blue (Booked) */
    .tile.tile--bg-blocked   { background: #F08784; }  /* soft coral (Blocked) */
    .tile.tile--bg-notavail  { background: #d32f2f; }  /* bright red (Unavailable) */
    .tile.tile--bg-available { background: #B1F99D; }  /* mint green (Available) */
    .tile.tile--bg-pending   { background: #000; }     /* black (No availability yet) */

    /* Text tones override any .status-* colors inside the tile */
    .tile.tile--tone-dark  .tile-status,
    .tile.tile--tone-dark  .tile-sub,
    .tile.tile--tone-dark  .edit-note { color: #0f1115; }

    .tile.tile--tone-light .tile-status,
    .tile.tile--tone-light .tile-sub,
    .tile.tile--tone-light .edit-note { color: #fff; }

    /* “Pending change” follows the tile tone rather than a fixed accent */
    .tile .edit-note { color: inherit; font-size: .85rem; font-weight: 700; }
    .status-pending { color: var(--muted); }
    .status-na      { color: var(--danger); }
    .status-ld,
    .status-n,
    .status-ldn     { color: var(--warn); }
    .status-booked  { color: var(--booked); }
    .status-blocked { color: var(--blocked); }

    .tile-sub {
      margin-top: .25rem;
      color: var(--muted);
      font-size: .9rem;
      line-height: 1.25;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    /* Fixed footer (space reserved via --footer-h) */
    .footer {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 20;
      background: rgba(15, 17, 21, .97);
      backdrop-filter: blur(6px);
      border-top: 1px solid #222936;
      padding: .55rem .9rem calc(.55rem + env(safe-area-inset-bottom));
      box-sizing: border-box;
      width: 100%;
    }

    .footer-inner {
      max-width: 1024px;
      margin: 0 auto;
      display: flex;
      gap: .6rem;
      align-items: center;
      width: 100%;
    }

    .footer .spacer { flex: 1; }

    .banner {
      padding: .5rem .7rem;
      border-radius: 10px;
      font-size: .9rem;
      border: 1px solid #2a3446;
      background: #131926;
      color: #a7b0c0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 50vw;
    }

    /* Utility */
    .hidden { visibility: hidden !important; pointer-events: none !important; opacity: 0; }

    .toast {
      position: fixed;
      right: .75rem;
      bottom: calc(5.25rem + env(safe-area-inset-bottom));
      background: #131926;
      color: var(--text);
      border: 1px solid #2a3446;
      padding: .6rem .75rem;
      border-radius: 10px;
      z-index: 25;
      box-shadow: 0 8px 30px rgba(0, 0, 0, .35);
      max-width: 90vw;
      font-size: .9rem;
    }

    /* Motion */
    @media (prefers-reduced-motion: no-preference) {
      @keyframes softPulse {
        0% { opacity: 1; transform: scale(1); }
        50% { opacity: .78; transform: scale(0.99); }
        100% { opacity: 1; transform: scale(1); }
      }
      @keyframes strongPulse {
        0% { opacity: 1; transform: scale(1); }
        50% { opacity: .72; transform: scale(1.03); }
        100% { opacity: 1; transform: scale(1); }
      }
      .needs-attention { animation: softPulse 1.6s ease-in-out infinite; }
      .btn-attention   { animation: strongPulse 1s ease-in-out infinite; }
    }

    /* Thin red border highlight for attention tiles */
    .attention-border { border-color: var(--danger) !important; }

    /* ===============================
       Samsung Fold cover-only tweaks
       (activated via JS by adding
        class "fold-cover" to <html>)
       =============================== */
    html.fold-cover main {
      padding-left: .6rem;
      padding-right: .6rem;
    }
    html.fold-cover .grid {
      /* keep the same column logic; just tighten spacing */
      gap: .4rem;
    }
    html.fold-cover .tile {
      padding: .5rem;
      border-radius: 12px;
    }
    html.fold-cover .tile-day,
    html.fold-cover .tile-date { font-size: .9rem; }
    html.fold-cover .tile-status { font-size: .95rem; }
    html.fold-cover .tile-sub    { font-size: .85rem; }
  </style>

  <!-- Emergency button compatibility shim (for old cached builds) -->
  <script>
    (function () {
      // 1) Minimal visibility helper if the new one doesn't exist
      if (!window.updateEmergencyButtonFromCache) {
        window.emergencyEligibilityCache = window.emergencyEligibilityCache || { eligible: [] };
        window.updateEmergencyButtonFromCache = function () {
          try {
            var btn = document.getElementById('emergencyBtn');
            if (!btn) return;
            var has = Array.isArray(window.emergencyEligibilityCache.eligible) &&
                      window.emergencyEligibilityCache.eligible.length > 0;

            // Never hide; grey+disabled when not eligible/loading
            btn.hidden = false;
            btn.className = 'btn btn-danger';
            btn.style.background = '#d32f2f';
            btn.style.color = '#fff';
            btn.style.border = '1px solid #b71c1c';

            if (has) {
              btn.disabled = false;
              btn.style.filter = '';
              btn.style.opacity = '';
            } else {
              btn.disabled = true;
              btn.style.filter = 'grayscale(1)';
              btn.style.opacity = '.85';
            }

            btn.style.marginLeft = '.5rem';   // gap from Refresh
            btn.style.position   = 'relative';
            btn.style.zIndex     = '3';
          } catch {}
        };

      }

      // 2) Minimal creator/wirer if the new one doesn't exist
      if (!window.ensureEmergencyButton) {
        window.ensureEmergencyButton = function () {
          var existing = document.getElementById('emergencyBtn');
          if (existing) { window.updateEmergencyButtonFromCache(); return; }

          var anchor =
            document.getElementById('refreshBtn') ||
            document.querySelector('#header .actions, .header .actions, .topbar .actions, .toolbar, #menuRight') ||
            document.getElementById('header') ||
            document.body;

          var btn = document.createElement('button');
          btn.id = 'emergencyBtn';
          btn.type = 'button';
          btn.textContent = 'Emergency';
          // Always visible; start disabled & greyed until eligibility arrives
          btn.hidden = false;
          btn.disabled = true;
          btn.className = 'btn btn-danger';
          btn.style.background = '#d32f2f';
          btn.style.color = '#fff';
          btn.style.border = '1px solid '#b71c1c';
          btn.style.filter = 'grayscale(1)';
          btn.style.opacity = '.85';

          anchor.appendChild(btn);

          // If the old app doesn't have openEmergencyOverlay, show a helpful prompt.
          btn.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            if (window.openEmergencyOverlay) {
              window.openEmergencyOverlay();
            } else {
              alert('There is an update to this app. Uninstall and close this down completely and reload. Please refresh or reopen the app.');
            }
          });

          window.updateEmergencyButtonFromCache();
        };

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', window.ensureEmergencyButton, { once: true });
        } else {
          window.ensureEmergencyButton();
        }
      }

      // 3) (Optional) If your constants exist, try to fetch eligibility once
      // so the button can appear even on very old builds.
      try {
        if (window.API_BASE_URL && typeof window.authToken === 'function') {
          fetch(window.API_BASE_URL + '?t=' + encodeURIComponent(window.authToken()) + '&view=emergency_window', {
            method: 'GET', credentials: 'omit'
          }).then(function(r){ return r.json(); }).then(function(j){
            if (j && Array.isArray(j.eligible)) {
              window.emergencyEligibilityCache = { eligible: j.eligible };
              window.updateEmergencyButtonFromCache();
            }
          }).catch(function(){});
        }
      } catch {}
    })();
  </script>

  <!-- Samsung Fold cover-screen detector:
       Adds "fold-cover" class to <html> ONLY on the narrow, tall outer screen of Samsung Fold.
       iPhones and all other devices remain unaffected. -->
  <script>
    (function () {
      function isSamsungFoldCover() {
        try {
          var ua = navigator.userAgent || '';
          var isSamsung = /Samsung/i.test(ua) || /SM-F9|SM-F93|SM-F94|SM-F91|SM-F92/.test(ua); // conservative
          if (!isSamsung) return false;

          var w = Math.min(window.innerWidth || 0, screen.width || 0);
          var h = Math.max(window.innerHeight || 0, screen.height || 0);

          // Cover traits: very narrow, very tall, portrait
          var narrow = w > 0 && w <= 400;          // cover is typically ~374–384 CSS px
          var tall   = (w > 0) && (h / w >= 2.2);  // tall aspect (≈ 21:9+)
          var portrait = h >= w;

          return narrow && tall && portrait;
        } catch (_) {
          return false;
        }
      }

      function applyFoldClass() {
        var on = isSamsungFoldCover();
        document.documentElement.classList.toggle('fold-cover', !!on);
      }

      // Apply on load + react to geometry changes
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', applyFoldClass, { once: true });
      } else {
        applyFoldClass();
      }
      window.addEventListener('resize', applyFoldClass, { passive: true });
      window.addEventListener('orientationchange', function () {
        setTimeout(applyFoldClass, 60);
      });
    })();
  </script>
</head>

<body>
  <noscript>
    <div style="padding:.75rem; background:#131926; color:#e7ecf3; border-bottom:1px solid #222936;">
      JavaScript is required to use this app.
    </div>
  </noscript>

  <header>
    <div class="name-and-logo">
      <h1 id="candidateName"></h1>
      <div id="lastLoaded" class="last-loaded hidden"></div>
      <img src="ARMSLOGO.png" alt="Company Logo" class="company-logo-overlay" />
    </div>

    <div class="spacer"></div>

    <button id="refreshBtn" type="button">Refresh</button>
    <button id="installBtn" type="button" class="btn-ghost hidden">Install</button>
  </header>

  <main>
    <div id="helpMsg">
      Please tap any date to change your availability — don’t forget to tap
      <strong>Submit</strong> when you’re done.
    </div>

    <div id="grid" class="grid"></div>
  </main>

  <!-- Fixed footer; real space reserved in <main> via --footer-h -->
  <div id="footer" class="footer hidden" role="region" aria-label="Submission actions">
    <div class="footer-inner">
      <span id="draftMsg" class="banner">You have unsaved changes.</span>
      <div class="spacer"></div>
      <button id="clearBtn" type="button" class="btn">Clear changes</button>
      <button id="submitBtn" type="button" class="btn-primary">Submit</button>
    </div>
  </div>

  <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>

  <!-- App logic -->
  <script src="app.js"></script>

  <!-- Service Worker registration (offline + install) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(() => {
          /* noop: offline is optional */
        });
      });
    }
  </script>

  <!-- Stable footer measurement + safe loader cleanup (no mutation loops) -->
  <script>
    (function () {
      const FOOTER = document.getElementById('footer');
      const GRID = document.getElementById('grid');

      // rAF debounce helper
      let rafId = 0;
      const rafDebounce = (fn) => {
        if (rafId) cancelAnimationFrame(rafId);
        rafId = requestAnimationFrame(() => { rafId = 0; fn(); });
      };

      // Footer height publisher (no class toggles)
      function publishFooterHeight() {
        if (!FOOTER) return;
        const h = Math.max(0, Math.round(FOOTER.getBoundingClientRect().height));
        document.documentElement.style.setProperty('--footer-h', h + 'px');
      }

      // One-time on load (plus a delayed pass for mobile UI bars)
      window.addEventListener('load', () => {
        publishFooterHeight();
        setTimeout(publishFooterHeight, 250);
      });

      // Resize/orientation (debounced)
      window.addEventListener('resize', () => rafDebounce(publishFooterHeight), { passive: true });
      window.addEventListener('orientationchange', () => {
        setTimeout(() => rafDebounce(publishFooterHeight), 200);
      });

      // Observe actual footer size changes (e.g., text wraps, button states)
      if ('ResizeObserver' in window && FOOTER) {
        const ro = new ResizeObserver(() => rafDebounce(publishFooterHeight));
        ro.observe(FOOTER);
      }

      // Safe loader cleanup (doesn't mutate watched attrs)
      function hideLoadersOnce() {
        ['#loading', '.loading', '.loading-overlay', '#spinner', '#progress'].forEach(sel => {
          document.querySelectorAll(sel).forEach(el => {
            el.style.display = 'none';
            el.setAttribute('aria-hidden', 'true');
          });
        });
      }

      // Hide loaders when DOM is ready and once tiles appear
      document.addEventListener('DOMContentLoaded', () => {
        hideLoadersOnce();
        setTimeout(hideLoadersOnce, 600);
      });

      if (GRID && 'MutationObserver' in window) {
        const mo = new MutationObserver(() => {
          if (GRID.children.length) hideLoadersOnce();
        });
        mo.observe(GRID, { childList: true });
      }

      // If app.js fails to load, warn clearly
      const appTag = Array.from(document.scripts).find(s => /app\.js(\?|$)/.test(s.src || ''));
      if (appTag) {
        appTag.addEventListener('error', () => {
          console.error('app.js failed to load (404/CORS?).');
          alert('app.js failed to load. Check its path and that you are serving over http:// or https:// (not file://).');
        });
      }
    })();
  </script>
</body>
</html>
